name: 'With Docker'
description: 'Run a given stage with Docker Image'
inputs:
  container-version:
    description: 'Docker Image Version'
    required: true
  container-name:
    description: 'Docker Container Name'
    required: true
runs:
  using: 'composite'
  steps:
  - name: 'Set up Docker'
    shell: bash {0}
    run: |
      set -euxo pipefail
      
      CONTAINER_NAME=${{inputs.container-name}}
      CONTAINER_VERSION=${{inputs.container-version}}
      
      docker build --tag kontrol-kup-ci .

      docker run                                                    \
        --name ${CONTAINER_NAME}                                    \
        --rm                                                        \
        --interactive                                               \
        --tty                                                       \
        --detach                                                    \
        --user root                                                 \
        --mount type=volume,source=nixstore-kup,dst=/nix/store:rw   \
        --workdir /home/ubuntu/workspace                            \
        kontrol-kup-ci

      # Copy the current Checkout direcotry into the container
      docker cp . ${CONTAINER_NAME}:/home/ubuntu/workspace
      docker exec ${CONTAINER_NAME} chown -R ubuntu:ubuntu /home/ubuntu
      docker exec ${CONTAINER_NAME} chown -R ubuntu:ubuntu /nix/store
